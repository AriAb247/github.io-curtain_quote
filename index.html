<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Quotation Maker – Rooms & Windows</title>
  <style>
    body { font-family: Arial, sans-serif; max-width:900px; margin:2rem auto; padding:0 1rem; }
    fieldset { margin-bottom:1.5rem; border:1px solid #ccc; padding:1rem; }
    legend { font-weight:bold; }
    label { display:block; margin:0.5rem 0; }
    input[type="text"], input[type="number"], select { width:100%; padding:0.3rem; }
    .btn { padding:0.4rem 0.8rem; margin:0.3rem; cursor:pointer; }
    .room, .window { border:1px dashed #999; padding:1rem; margin-bottom:1rem; position: relative; }
    .window { background:#f9f9f9; }
    .remove-btn { position: absolute; top:0.5rem; right:0.5rem; background:#e74c3c; color:#fff; border:none; }
    .calc-output { font-weight:bold; }
    #quotePreview { display:none; background:#fff; padding:1rem; margin-top:2rem; }
    #quotePreview h2 { margin-top:0; }
    .room-quote { margin-bottom:1.5rem; }
    .window-quote { margin-left:1rem; margin-bottom:1rem; }
    .total { font-weight:bold; }
  </style>
</head>
<body>

  <h1>Mum’s Curtains Ltd. – Quotation Maker</h1>

  <!-- Container for all rooms -->
  <div id="roomsContainer"></div>

  <!-- Buttons -->
  <button id="addRoomBtn" class="btn">Add Room</button>
  <button id="generateBtn" class="btn">Generate PDF Quotation</button>

  <!-- Hidden preview panel for PDF generation -->
  <div id="quotePreview">
    <h2>Quotation</h2>
    <p><strong>Date:</strong> <span id="qDate"></span></p>
    <div id="quoteContent"></div>
    <p class="total">Grand Total: £<span id="qGrandTotal"></span></p>
  </div>

  <!-- html2pdf.js via CDN -->
  <script src="https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script>
    // UTIL: format date as DD/MM/YYYY
    function formatDate(d) {
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth()+1).padStart(2, '0');
      return dd + '/' + mm + '/' + d.getFullYear();
    }

    let roomCount = 0;

    // Create a new room block
    function createRoom() {
      roomCount++;
      const roomDiv = document.createElement('div');
      roomDiv.className = 'room';
      roomDiv.dataset.roomId = roomCount;

      roomDiv.innerHTML = `
        <button class="remove-btn removeRoomBtn">× Remove Room</button>
        <label>
          Room Name:
          <input type="text" class="roomName" placeholder="e.g. Living Room" required>
        </label>
        <button class="btn addWindowBtn">Add Window</button>
        <div class="windowsContainer"></div>
      `;
      // Attach remove-room handler
      roomDiv.querySelector('.removeRoomBtn')
        .addEventListener('click', () => roomDiv.remove());
      // Attach handler for adding windows
      roomDiv.querySelector('.addWindowBtn')
        .addEventListener('click', () => createWindow(roomDiv.querySelector('.windowsContainer')));

      document.getElementById('roomsContainer').appendChild(roomDiv);
    }

    // Create a new window block inside a given container
    function createWindow(container) {
      const winDiv = document.createElement('div');
      winDiv.className = 'window';

      // Build the inner HTML with all fields
      winDiv.innerHTML = `
        <button class="remove-btn removeWindowBtn">× Remove Window</button>
        <label>Height (m): <input type="number" class="height" min="0" step="0.01" required></label>
        <label>Width (m): <input type="number" class="width" min="0" step="0.01" required></label>
        <label>Window Size (m²): <span class="calc-output windowSize">0</span></label>

        <label>
          Heading:
          <select class="heading">
            <option>Pinch Pleat - Double</option>
            <option>Pinch Pleat - Triple</option>
            <option>Pencil Pleat - 3”</option>
            <option>Pencil Pleat - 6”</option>
            <option>Eyelet</option>
            <option>Wave</option>
          </select>
        </label>

        <label>Fabric (m): <input type="number" class="fabricMeters" min="0" step="0.01" required></label>
        <label>Fabric Cost/m (£): <input type="number" class="fabricCostPerM" min="0" step="0.01" required></label>
        <label>Total Fabric Cost (£): <span class="calc-output totalFabricCost">0</span></label>

        <label>
          Lining:
          <select class="liningType">
            <option>Normal</option>
            <option>Thermal</option>
            <option>Blackout</option>
            <option>Intertherm</option>
          </select>
        </label>
        <label>Lining Cost (£): <input type="number" class="liningCost" min="0" step="0.01" required></label>

        <label>Tape (m) [Width ×1.37]: <span class="calc-output tapeLength">0</span></label>
        <label>Tape Cost/m (£): <input type="number" class="tapeCostPerM" min="0" step="0.01" required></label>
        <label>Total Tape Cost (£): <span class="calc-output totalTapeCost">0</span></label>

        <label>Buckram (m) [Height ×1.5]: <span class="calc-output buckramLength">0</span></label>
        <label>Buckram Cost/m (£): <input type="number" class="buckramCostPerM" min="0" step="0.01" required></label>
        <label>Total Buckram Cost (£): <span class="calc-output totalBuckramCost">0</span></label>

        <label>Labour (£): <input type="number" class="labourCost" min="0" step="0.01" required></label>

        <label>
          Accessories:
          <select class="accessory">
            <option>Track</option>
            <option>Pole</option>
          </select>
        </label>

        <label><input type="checkbox" class="fittingIncluded"> Fitting included</label>
        <label>Fitting Cost (£): <input type="number" class="fittingCost" min="0" step="0.01" disabled></label>

        <label><input type="checkbox" class="hangingIncluded"> Hanging included</label>
        <label>Hanging Cost (£): <input type="number" class="hangingCost" min="0" step="0.01" disabled></label>
      `;

      // Remove-window handler
      winDiv.querySelector('.removeWindowBtn')
        .addEventListener('click', () => winDiv.remove());

      // Recalc all dynamic fields
      const recalcAll = () => {
        const h = parseFloat(winDiv.querySelector('.height').value) || 0;
        const w = parseFloat(winDiv.querySelector('.width').value) || 0;
        const area = h * w;
        winDiv.querySelector('.windowSize').textContent = area.toFixed(2);

        const fabM = parseFloat(winDiv.querySelector('.fabricMeters').value) || 0;
        const fabP = parseFloat(winDiv.querySelector('.fabricCostPerM').value) || 0;
        winDiv.querySelector('.totalFabricCost').textContent = (fabM * fabP).toFixed(2);

        winDiv.querySelector('.tapeLength').textContent = (w * 1.37).toFixed(2);
        const tapeCostM = parseFloat(winDiv.querySelector('.tapeCostPerM').value) || 0;
        const tapeLen = w * 1.37;
        winDiv.querySelector('.totalTapeCost').textContent = (tapeCostM * tapeLen).toFixed(2);

        winDiv.querySelector('.buckramLength').textContent = (h * 1.5).toFixed(2);
        const buckCostM = parseFloat(winDiv.querySelector('.buckramCostPerM').value) || 0;
        const buckLen = h * 1.5;
        winDiv.querySelector('.totalBuckramCost').textContent = (buckCostM * buckLen).toFixed(2);
      };

      // Enable/disable fitting & hanging cost inputs
      winDiv.querySelector('.fittingIncluded').addEventListener('change', e => {
        winDiv.querySelector('.fittingCost').disabled = !e.target.checked;
      });
      winDiv.querySelector('.hangingIncluded').addEventListener('change', e => {
        winDiv.querySelector('.hangingCost').disabled = !e.target.checked;
      });

      // Attach recalc on all relevant inputs
      ['height','width','fabricMeters','fabricCostPerM','tapeCostPerM','buckramCostPerM']
        .forEach(cls => winDiv.querySelector(`.${cls}`)
          .addEventListener('input', recalcAll));

      container.appendChild(winDiv);
    }

    // Build the quotation preview HTML
    function buildQuotation() {
      const rooms = document.querySelectorAll('.room');
      let grandTotal = 0;
      let html = '';

      rooms.forEach(room => {
        const name = room.querySelector('.roomName').value || 'Unnamed Room';
        html += `<div class="room-quote"><h3>Room: ${name}</h3>`;
        room.querySelectorAll('.window').forEach((win, idx) => {
          // Gather values
          const h = parseFloat(win.querySelector('.height').value) || 0;
          const w = parseFloat(win.querySelector('.width').value) || 0;
          const area = h * w;
          const heading = win.querySelector('.heading').value;
          const fabM = parseFloat(win.querySelector('.fabricMeters').value) || 0;
          const fabP = parseFloat(win.querySelector('.fabricCostPerM').value) || 0;
          const totalFab = fabM * fabP;
          const lining = win.querySelector('.liningType').value;
          const liningCost = parseFloat(win.querySelector('.liningCost').value) || 0;
          const tapeLen = w * 1.37;
          const tapeCostM = parseFloat(win.querySelector('.tapeCostPerM').value) || 0;
          const totalTape = tapeLen * tapeCostM;
          const buckLen = h * 1.5;
          const buckCostM = parseFloat(win.querySelector('.buckramCostPerM').value) || 0;
          const totalBuck = buckLen * buckCostM;
          const labour = parseFloat(win.querySelector('.labourCost').value) || 0;
          const accessory = win.querySelector('.accessory').value;
          const fitIncl = win.querySelector('.fittingIncluded').checked;
          const fitCost = fitIncl ? (parseFloat(win.querySelector('.fittingCost').value) || 0) : 0;
          const hangIncl = win.querySelector('.hangingIncluded').checked;
          const hangCost = hangIncl ? (parseFloat(win.querySelector('.hangingCost').value) || 0) : 0;

          // Sum window total
          const windowTotal = totalFab + liningCost + totalTape + totalBuck + labour + fitCost + hangCost;
          grandTotal += windowTotal;

          // Append HTML for this window
          html += `
            <div class="window-quote">
              <strong>Window ${idx+1}</strong> (Size: ${area.toFixed(2)} m²)<br>
              Heading: ${heading}<br>
              Fabric: ${fabM} m @ £${fabP}/m = £${totalFab.toFixed(2)}<br>
              Lining: ${lining} @ £${liningCost.toFixed(2)}<br>
              Tape: ${tapeLen.toFixed(2)} m @ £${tapeCostM}/m = £${totalTape.toFixed(2)}<br>
              Buckram: ${buckLen.toFixed(2)} m @ £${buckCostM}/m = £${totalBuck.toFixed(2)}<br>
              Labour: £${labour.toFixed(2)}<br>
              Accessories: ${accessory}<br>
              ${fitIncl ? `Fitting @ £${fitCost.toFixed(2)}<br>` : ''}
              ${hangIncl ? `Hanging @ £${hangCost.toFixed(2)}<br>` : ''}
              <em>Window Total: £${windowTotal.toFixed(2)}</em>
            </div>`;
        });
        html += `</div>`;
      });

      document.getElementById('qDate').textContent = formatDate(new Date());
      document.getElementById('quoteContent').innerHTML = html;
      document.getElementById('qGrandTotal').textContent = grandTotal.toFixed(2);
      document.getElementById('quotePreview').style.display = 'block';
    }

    // On clicking Generate: build preview then trigger PDF download
    document.getElementById('generateBtn').addEventListener('click', () => {
      buildQuotation();
      html2pdf().from(document.getElementById('quotePreview')).set({
        margin: 0.5,
        filename: `Quotation_${formatDate(new Date()).replace(/\//g,'-')}.pdf`,
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      }).save();
    });

    // Initial room on load
    document.getElementById('addRoomBtn').addEventListener('click', createRoom);
    createRoom();
  </script>
</body>
</html>
