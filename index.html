<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Oxford Curtains and Alterations Quotation Maker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    label { display: block; margin: 0.5rem 0; }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 0.3rem;
    }
    .btn {
      padding: 0.4rem 0.8rem;
      margin: 0.3rem;
      cursor: pointer;
    }
    .room, .window {
      border: 1px dashed #999;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }
    .window {
      background: #f9f9f9;
    }
    .remove-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: #e74c3c;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .calc-output { font-weight: bold; }

    /* PDF preview styling */
    #quotePreview {
      display: none;
      background: #fff;
      padding: 1rem;
      margin-top: 2rem;
      /* no overflow so entire preview is captured */
    }
    #quotePreview .business-header {
      float: left;
      margin-bottom: 1rem;
      margin-right: 1rem;
    }
    /* allow html2canvas to pull in the logo */
    #quotePreview .business-header img {
      max-width: 150px;
      display: block;
      margin-bottom: 0.5rem;
    }
    #quotePreview .clearfix { clear: both; }
    #quotePreview h2 { margin-top: 0; }
    .room-quote { margin-bottom: 1.5rem; }
    .window-quote {
      margin-left: 1rem;
      margin-bottom: 1rem;
    }
    .total { font-weight: bold; }
  </style>
</head>
<body>

  <h1>Oxford Curtains and Alterations Quotation Maker</h1>

  <!-- Dynamic rooms will go here -->
  <div id="roomsContainer"></div>

  <!-- Controls -->
  <button id="addRoomBtn" class="btn">Add Room</button>
  <button id="generateBtn" class="btn">Generate PDF Quotation</button>

  <!-- Hidden preview for PDF generation -->
  <div id="quotePreview">
    <div class="business-header">
      <!-- crossOrigin allows html2canvas to draw this image -->
      <img src="Oxford_Curtains.png" alt="Oxford Curtains Logo" crossorigin="anonymous">
      <p style="margin:0; font-size:0.9rem;">
        <strong>Oxford Curtains and Alterations Ltd</strong><br>
        160 Westminster Way<br>
        Botley, Oxford<br>
        OX2 0LR
      </p>
    </div>
    <div class="clearfix"></div>

    <h2>Quotation</h2>
    <p><strong>Date:</strong> <span id="qDate"></span></p>
    <div id="quoteContent"></div>
    <p class="total">Grand Total: £<span id="qGrandTotal"></span></p>
  </div>

  <!-- html2pdf.js library -->
  <script src="https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script>
    // Utility: format Date as DD/MM/YYYY
    function formatDate(d) {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      return dd + '/' + mm + '/' + d.getFullYear();
    }

    let roomCount = 0;

    // Create a new Room block
    function createRoom() {
      roomCount++;
      const roomDiv = document.createElement('div');
      roomDiv.className = 'room';
      roomDiv.innerHTML = `
        <button class="remove-btn removeRoomBtn">× Remove Room</button>
        <label>Room Name: <input type="text" class="roomName" placeholder="e.g. Living Room" required></label>
        <button class="btn addWindowBtn">Add Window</button>
        <div class="windowsContainer"></div>
      `;
      // Remove room
      roomDiv.querySelector('.removeRoomBtn')
             .addEventListener('click', () => roomDiv.remove());
      // Add window
      roomDiv.querySelector('.addWindowBtn')
             .addEventListener('click', () => createWindow(roomDiv.querySelector('.windowsContainer')));
      document.getElementById('roomsContainer').appendChild(roomDiv);
    }

    // Create a new Window block within a Room
    function createWindow(container) {
      const winDiv = document.createElement('div');
      winDiv.className = 'window';
      winDiv.innerHTML = `
        <button class="remove-btn removeWindowBtn">× Remove Window</button>

        <label>Height (m): <input type="number" class="height" min="0" step="0.01" required></label>
        <label>Width (m): <input type="number" class="width" min="0" step="0.01" required></label>
        <label>Window Size (m²): <span class="calc-output windowSize">0</span></label>

        <label>Heading:
          <select class="heading">
            <option>Pinch Pleat - Double</option>
            <option>Pinch Pleat - Triple</option>
            <option>Pencil Pleat - 3”</option>
            <option>Pencil Pleat - 6”</option>
            <option>Eyelet</option>
            <option>Wave</option>
          </select>
        </label>

        <label>Fabric (m): <input type="number" class="fabricMeters" min="0" step="0.01" required></label>
        <label>Fabric Cost/m (£): <input type="number" class="fabricCostPerM" min="0" step="0.01" required></label>
        <label>Total Fabric Cost (£): <span class="calc-output totalFabricCost">0</span></label>

        <label>Lining:
          <select class="liningType">
            <option>Normal</option>
            <option>Thermal</option>
            <option>Blackout</option>
            <option>Intertherm</option>
          </select>
        </label>
        <label>Lining Cost (£): <input type="number" class="liningCost" min="0" step="0.01" required></label>

        <label>Tape (m) [Width ×1.37]: <span class="calc-output tapeLength">0</span></label>
        <label>Tape Cost/m (£): <input type="number" class="tapeCostPerM" min="0" step="0.01" required></label>
        <label>Total Tape Cost (£): <span class="calc-output totalTapeCost">0</span></label>

        <label>Buckram (m) [Height ×1.5]: <span class="calc-output buckramLength">0</span></label>
        <label>Buckram Cost/m (£): <input type="number" class="buckramCostPerM" min="0" step="0.01" required></label>
        <label>Total Buckram Cost (£): <span class="calc-output totalBuckramCost">0</span></label>

        <label>Labour (£): <input type="number" class="labourCost" min="0" step="0.01" required></label>

        <label><input type="checkbox" class="accessoriesIncluded"> Accessories included</label>
        <label>Accessory Type:
          <select class="accessoryType" disabled>
            <option>Track</option>
            <option>Pole</option>
          </select>
        </label>
        <label>Accessories Cost (£): <input type="number" class="accessoryCost" disabled></label>

        <label><input type="checkbox" class="fittingIncluded"> Fitting included</label>
        <label>Fitting Cost (£): <input type="number" class="fittingCost" disabled></label>

        <label><input type="checkbox" class="hangingIncluded"> Hanging included</label>
        <label>Hanging Cost (£): <input type="number" class="hangingCost" disabled></label>
      `;

      // Remove window
      winDiv.querySelector('.removeWindowBtn')
            .addEventListener('click', () => winDiv.remove());

      // Toggle conditional inputs
      winDiv.querySelector('.accessoriesIncluded')
            .addEventListener('change', e => {
              winDiv.querySelector('.accessoryType').disabled = !e.target.checked;
              winDiv.querySelector('.accessoryCost').disabled = !e.target.checked;
            });
      winDiv.querySelector('.fittingIncluded')
            .addEventListener('change', e => {
              winDiv.querySelector('.fittingCost').disabled = !e.target.checked;
            });
      winDiv.querySelector('.hangingIncluded')
            .addEventListener('change', e => {
              winDiv.querySelector('.hangingCost').disabled = !e.target.checked;
            });

      // Live recalculations for all measured inputs
      const recalc = () => {
        const h = parseFloat(winDiv.querySelector('.height').value) || 0;
        const w = parseFloat(winDiv.querySelector('.width').value) || 0;
        winDiv.querySelector('.windowSize').textContent = (h * w).toFixed(2);

        const fm = parseFloat(winDiv.querySelector('.fabricMeters').value) || 0;
        const fp = parseFloat(winDiv.querySelector('.fabricCostPerM').value) || 0;
        winDiv.querySelector('.totalFabricCost').textContent = (fm * fp).toFixed(2);

        const tl = w * 1.37;
        winDiv.querySelector('.tapeLength').textContent = tl.toFixed(2);
        const tcp = parseFloat(winDiv.querySelector('.tapeCostPerM').value) || 0;
        winDiv.querySelector('.totalTapeCost').textContent = (tl * tcp).toFixed(2);

        const bl = h * 1.5;
        winDiv.querySelector('.buckramLength').textContent = bl.toFixed(2);
        const bcp = parseFloat(winDiv.querySelector('.buckramCostPerM').value) || 0;
        winDiv.querySelector('.totalBuckramCost').textContent = (bl * bcp).toFixed(2);
      };
      ['height','width','fabricMeters','fabricCostPerM','tapeCostPerM','buckramCostPerM']
        .forEach(cls => winDiv.querySelector(`.${cls}`)
          .addEventListener('input', recalc));

      container.appendChild(winDiv);
    }

    // Build the quotation HTML in the preview
    function buildQuotation() {
      let grandTotal = 0, html = '';
      document.querySelectorAll('.room').forEach((r, ri) => {
        const roomName = r.querySelector('.roomName').value.trim() || 'Unnamed Room';
        html += `<div class="room-quote"><h3>Room: ${roomName}</h3>`;
        r.querySelectorAll('.window').forEach((w, wi) => {
          const h = +w.querySelector('.height').value || 0;
          const width = +w.querySelector('.width').value || 0;
          const area = h * width;
          const fm = +w.querySelector('.fabricMeters').value || 0;
          const fp = +w.querySelector('.fabricCostPerM').value || 0;
          const tf = fm * fp;
          const lc = +w.querySelector('.liningCost').value || 0;
          const tl = width * 1.37, tcp = +w.querySelector('.tapeCostPerM').value || 0;
          const tt = tl * tcp;
          const bl = h * 1.5, bcp = +w.querySelector('.buckramCostPerM').value || 0;
          const tb = bl * bcp;
          const lab = +w.querySelector('.labourCost').value || 0;
          const ai = w.querySelector('.accessoriesIncluded').checked;
          const ac = ai ? +w.querySelector('.accessoryCost').value || 0 : 0;
          const fi = w.querySelector('.fittingIncluded').checked;
          const fc = fi ? +w.querySelector('.fittingCost').value || 0 : 0;
          const hi = w.querySelector('.hangingIncluded').checked;
          const hc = hi ? +w.querySelector('.hangingCost').value || 0 : 0;
          const total = tf + lc + tt + tb + lab + ac + fc + hc;
          grandTotal += total;

          html += `
            <div class="window-quote">
              <strong>Window ${wi+1}</strong> (${area.toFixed(2)} m²)<br>
              Fabric: ${fm}m @ £${fp}=£${tf.toFixed(2)}<br>
              Lining: £${lc.toFixed(2)}<br>
              Tape: ${tl.toFixed(2)}m @ £${tcp}=£${tt.toFixed(2)}<br>
              Buckram: ${bl.toFixed(2)}m @ £${bcp}=£${tb.toFixed(2)}<br>
              Labour: £${lab.toFixed(2)}<br>
              ${ai?`Accessories @ £${ac.toFixed(2)}<br>`:''}
              ${fi?`Fitting @ £${fc.toFixed(2)}<br>`:''}
              ${hi?`Hanging @ £${hc.toFixed(2)}<br>`:''}
              <em>Window Total: £${total.toFixed(2)}</em>
            </div>`;
        });
        html += `</div>`;
      });

      document.getElementById('qDate').textContent = formatDate(new Date());
      document.getElementById('quoteContent').innerHTML = html;
      document.getElementById('qGrandTotal').textContent = grandTotal.toFixed(2);
      document.getElementById('quotePreview').style.display = 'block';
    }

    // PDF generation: includes useCORS and scrollY fix
    document.getElementById('generateBtn').addEventListener('click', () => {
      buildQuotation();
      const preview = document.getElementById('quotePreview');
      preview.style.display = 'block';

      html2pdf().set({
        margin: 0.5,
        filename: `Quotation_${formatDate(new Date()).replace(/\//g,'-')}.pdf`,
        html2canvas: {
          scale: 2,
          useCORS: true,
          scrollY: -window.scrollY
        },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      })
      .from(preview)
      .save();
    });

    // Initialize with one room
    document.getElementById('addRoomBtn').addEventListener('click', createRoom);
    createRoom();
  </script>
</body>
</html>
